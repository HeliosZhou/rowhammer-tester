# ZCU104 ROWHAMMER 研究完整指南

## 基于antmicro开源项目的ZCU-104板
-**芯片型号**:（三星）Samsung M471A1K43EB1-CWE
-**内存类型**:DDR4 SO-DRAM（外置）
-**总容量**:8GB
-**系统时钟**:125MHZ
-**速度等级**:DDR4-3200

## SD卡配置
```bash
# 0. 准备好bit流文件以及EtherBone文件


# 1. 找到预构建镜像 zcu104.img
  cd /home/hc/rowhammer-tester/firmware/zcu104/zcu104-image && ls -la

# 2. 找到您的SD卡设备名（例如 /dev/sdb），卸载SD卡的所有分区，以防写入错误
  lsblk
  sudo umount /dev/sdb1 /dev/sdb2
  lsblk | grep sdb

# 3. 使用dd命令将镜像写入SD卡
  sudo dd status=progress oflag=sync bs=4M if=zcu104.img of=<DEVICE>
  cd /home/hc/rowhammer-tester/firmware/zcu104/zcu104-image && sudo dd status=progress oflag=sync bs=4M if=zcu104.img of=/dev/sdb

# 4. 检查是否写入成功，并且校验
  lsblk | grep sdb
  cat zcu104.img.sha256sum
  # 原始镜像文件的校验和：
  # 60e12219dbe0885627551354d538324354aeabf4242d2a8b7f47704925df0df9
  sudo dd if=/dev/sdb bs=197132800 count=1 | sha256sum
  # 从SD卡读取的数据校验和：
  # 60e12219dbe0885627551354d538324354aeabf4242d2a8b7f47704925df0df9

# 5. 测试网络功能，以及picocom是否正常
  ping -c 3 192.168.100.50 
  ls /dev/ttyUSB* 2>/dev/null || echo "未找到ttyUSB设备"
  picocom -b 115200 /dev/ttyUSB1

# 6. 使用SSH更改bit流文件以及EtherBone文件，成功后重启
  ssh root@192.168.100.50
  scp /home/hc/rowhammer-tester-ZCU104/build/zcu104/gateware/zcu104.bit root@192.168.100.50:/boot/zcu104.bit # 本地终端运行
  ssh root@192.168.100.50 "ls -la /boot/ | grep zcu104.bit" #查看是否成功
  ls -la /home/hc/rowhammer-tester-ZCU104/build/zcu104/gateware/xilinx_zcu104.bit # 验证文件大小是否正确
  ssh root@192.168.100.50 'sync; reboot' # 重启系统

killall zcu104_etherbone
scp /home/hc/rowhammer-tester/firmware/zcu104/etherbone/build/zcu104_etherbone  root@192.168.100.50:/bin/zcu104_etherbone 
ssh root@192.168.100.50 "ls -la /bin/zcu104_etherbone"

# 7.验证系统功能是否正常
ping -c 3 192.168.100.50 # 确保网络正常

picocom -b 115200 /dev/ttyUSB1 #终端1
  # 若显示占用 
  lsof /dev/ttyUSB1 # 查看进程PID
  kill -9 1363756

source venv/bin/activate
export TARGET=zcu104 && export IP_ADDRESS=192.168.100.50  
make srv # 终端2
  # 若显示占用
  ps aux | grep litex_server
  
source venv/bin/activate
export TARGET=zcu104 && export IP_ADDRESS=192.168.100.50  
cd rowhammer_tester/scripts/
python leds.py -t 1000 # 终端3（LED灯每隔1S轮换闪烁）


```



## 重点：如何做不同SO-DIMM的适配？
```bash
# bit流文件的更新
export TARGET=zcu104 && make build ARGS="--module=M471A1K43EB1 --speedgrade=1000"
export TARGET=zcu104 && make build ARGS="--module=M471A1K43EB1"

```

```bash
# bios调试方法以及结果
python bios_console.py
# sys-clk-freq 125MHz  (DDR4-3200，测试异常) 
--=============== SoC ==================--
CPU:            VexRiscv_Lite @ 125MHz
BUS:            WISHBONE 32-bit @ 4GiB
CSR:            32-bit data
ROM:            128.0KiB
SRAM:           8.0KiB
L2:             8.0KiB
Couldn't read SDRAM size from the SPD, defaulting to 256 MB.
SDRAM:          256.0MiB 64-bit @ 1000MT/s (CL-9 CWL-9)
MAIN-RAM:       1.0GiB
``` 
```bash
# sys-clk-freq 125MHz  (DDR4-3200，测试正常) 
--=============== SoC ==================--
CPU:            VexRiscv_Min @ 125MHz
BUS:            WISHBONE 32-bit @ 4GiB
CSR:            32-bit data
ROM:            64.0KiB
SRAM:           8.0KiB
L2:             256B
SDRAM:          8.0GiB 64-bit @ 1000MT/s (CL-9 CWL-9)
MAIN-RAM:       1.0GiB




litex> i2c_write 0x74 0x00 1 0x80 
# 0x74 是 I2C mux（如 PCA9548），0x80 选择了连接到 SO-DIMM SPD 的通道。

litex> i2c_scan                  
       0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
0x00: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
0x10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
0x20: 20 -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
0x30: 30 -- -- -- -- 35 36 37 -- -- -- -- -- -- -- --
0x40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
0x50: -- 51 -- -- -- -- -- -- -- -- -- -- -- -- -- --
0x60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
0x70: -- -- -- -- 74 -- -- -- -- -- -- -- -- -- -- --

# SPD EEPROM的I2C地址就是 0x51，但只有在 mux 0x80 通道下才连通到SO-DIMM。
# 你要想自动读取SPD，必须先用 i2c_write 0x74 0x00 1 0x80 选通通道，再用 sdram_spd 1 读取。

litex> sdram_spd 1
Memory dump:
0x00000000  23 11 0c 03 85 21 00 08 00 60 00 03 01 03 00 00  #....!...`......
0x00000010  00 00 05 0d f8 ff 02 00 6e 6e 6e 11 00 6e f0 0a  ........nnn..n..
0x00000020  20 08 00 05 00 a8 14 28 28 00 78 00 14 3c 00 00   ......((.x..<..
0x00000030  00 00 00 00 00 00 00 00 00 00 00 00 0c 2b 2d 04  .............+-.
0x00000040  16 35 23 0d 00 00 2c 0b 03 24 35 0c 03 2d 00 00  .5#...,..$5..-..
0x00000050  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x00000060  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x00000070  00 00 00 00 00 00 9c 00 00 00 00 00 e7 00 e4 12  ................
0x00000080  0f 11 20 00 00 00 00 00 00 00 00 00 00 00 00 00  .. .............
0x00000090  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x000000a0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x000000b0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x000000c0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x000000d0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x000000e0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x000000f0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 ef 55  ...............U
0x00000100  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x00000110  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x00000120  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x00000130  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x00000140  80 ce 04 21 42 48 4c 0b ed 4d 34 37 31 41 31 4b  ...!BHL..M471A1K
0x00000150  34 33 45 42 31 2d 43 57 45 20 20 20 20 00 80 ce  43EB1-CWE    ...
0x00000160  00 54 31 59 4e 30 30 30 04 37 01 00 01 00 00 49  .T1YN000.7.....I
0x00000170  01 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x00000180  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x00000190  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x000001a0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x000001b0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x000001c0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x000001d0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x000001e0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
0x000001f0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................

---


备份原始文件，然后用修正后的文件替换它：
cp /media/hc/BOOT/system.dtb /media/hc/BOOT/system.dtb.backup
cp /home/hc/rowhammer-tester-ZCU104/prebuilt/zcu104-image/system_fixed.dtb /media/hc/BOOT/system.dtb
ls -la /media/hc/BOOT/*.dtb*
md5sum /home/hc/rowhammer-tester-ZCU104/prebuilt/zcu104-image/system_fixed.dtb /media/hc/BOOT/system.dtb
```

## mem.py

```bash
# 包含内存速度测试(感觉有问题，读数据太慢了)
python mem.py --memspeed
Size = 0x00001000
Write speed: 7026.53 KB/s (0.0 sec)
Read  speed:   2.85 KB/s (1.4 sec)
Size = 0x00010000
Write speed: 11832.88 KB/s (0.0 sec)
Read  speed:   2.98 KB/s (22.0 sec)
Size = 0x00100000
Write speed: 9808.75 KB/s (0.1 sec)

```

## python bios_console.py 
```bash
leds                     - Set Leds value
flush_l2_cache           - Flush L2 cache
flush_cpu_dcache         - Flush CPU data cache
crc                      - Compute CRC32 of a part of the address space
ident                    - Identifier of the system
  Ident: Row Hammer Tester SoC on xczu7ev-ffvc1156-2-i, git: 540f5b61acc5ea76de4def70c3939808267a98f6 2025-11-24 21:15:20
help                     - Print this help

serialboot               - Boot from Serial (SFL)
reboot                   - Reboot
boot                     - Boot from Memory

mem_cmp                  - Compare memory content
mem_speed                - Test memory speed
  Memspeed at 0x40000000 (Sequential, 64.0KiB)...
    Read speed: 59.1MiB/s

mem_test                 - Test memory access
  Memtest at 0x40000000 (16.0MiB)...
    Write: 0x40000000-0x41000000 16.0MiB    
    Read: 0x40000000-0x41000000 16.0MiB    
  Memtest OK

mem_copy                 - Copy address space
mem_write                - Write address space
mem_read                 - Read address space

mem_list                 - List available memory regions
  Available memory regions:
  ROM           0x00000000 0x10000 
  SRAM          0x10000000 0x2000 
  MAIN_RAM      0x40000000 0x40000000 
  PATTERN_DATA  0x20000000 0x400 
  PATTERN_ADDR  0x21000000 0x40 
  PAYLOAD       0x30000000 0x8000 
  SCRATCHPAD    0x31000000 0x400 
  CSR           0xf0000000 0x10000

i2c_dev                  - List/Set I2C controller(s)
i2c_scan                 - Scan for I2C slaves
i2c_read                 - Read over I2C
i2c_write                - Write over I2C
i2c_reset                - Reset I2C line state

sdram_spd                - Read SDRAM SPD EEPROM
sdram_mr_write           - Write SDRAM Mode Register
sdram_force_bitslip      - Force write leveling Bitslip
sdram_rst_bitslip        - Reset write leveling Bitslip
sdram_force_dat_delay    - Force write leveling Dat delay
sdram_rst_dat_delay      - Reset write leveling Dat delay
sdram_cal                - Calibrate SDRAM
sdram_test               - Test SDRAM
sdram_init               - Initialize SDRAM (Init + Calibration)
sdram_force_cmd_delay    - Force write leveling Cmd delay
sdram_rst_cmd_delay      - Reset write leveling Cmd delay
sdram_force_wrphase      - Force write phase
sdram_force_rdphase      - Force read phase
sdram_hw_test            - Run SDRAM HW-accelerated memtest
  sdram_hw_test 0x40000000 0x4000000
sdram_bist               - Run SDRAM Build-In Self-Test
  sdram_bist 64 0
```


## 常用指令
```bash
# 设置环境变量
export TARGET=zcu104 && export IP_ADDRESS=192.168.100.50 && cd rowhammer_tester/scripts/
# 测试

python rowhammer.py --row-pairs const --const-rows-pair 10 12 --read_count 10e5 --no-refresh
python hw_rowhammer.py --row-pairs const --const-rows-pair 10 15 --read_count 1e5 --no-refresh --nrows 512 --start-row 90